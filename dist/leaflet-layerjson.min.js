/* 
 * Leaflet JSON Layer v0.3.3 - 2019-12-27 
 * 
 * Copyright 2019 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * https://opengeo.tech/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demo: 
 * https://opengeo.tech/maps/leaflet-layerjson/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-layerjson.git 
 * 
 */
(function(){L.LayerJSON=L.FeatureGroup.extend({includes:"1"===L.version[0]?L.Evented.prototype:L.Mixin.Events,options:{url:"",jsonpParam:null,callData:null,filterData:null,locAsGeoJSON:!1,propertyItems:"",propertyTitle:"title",propertyLoc:"loc",propertyId:"id",layerTarget:null,dataToMarker:null,buildPopup:null,buildIcon:null,optsPopup:null,minZoom:10,caching:!0,cacheId:null,minShift:1e3,precision:6,updateMarkers:!1,attribution:""},initialize:function(a){L.FeatureGroup.prototype.initialize.call(this,[]),L.Util.setOptions(this,a),this._dataToMarker=this.options.dataToMarker||this._defaultDataToMarker,this._buildIcon=this.options.buildIcon||this._defaultBuildIcon,this._filterData=this.options.filterData||null,this._hashUrl=this.options.url,this._hashUrl?(this._callData=this.getAjax,this.options.jsonpParam&&(this._hashUrl+="&"+this.options.jsonpParam+"=",this._callData=this.getJsonp)):this._callData=this.options.callData,this._curReq=null,this._center=null,this._cacheBounds=null,this._markersCache={}},onAdd:function(a){L.FeatureGroup.prototype.onAdd.call(this,a),this._center=a.getCenter(),this._cacheBounds=a.getBounds(),a.on("moveend zoomend",this._onMove,this),this.update()},onRemove:function(a){a.off("moveend zoomend",this._onMove,this),L.FeatureGroup.prototype.onRemove.call(this,a);for(var b in this._layers)this._layers.hasOwnProperty(b)&&L.FeatureGroup.prototype.removeLayer.call(this,this._layers[b])},getAttribution:function(){return this.options.attribution},addLayer:function(a){return this.options.layerTarget?(this.options.layerTarget.addLayer.call(this.options.layerTarget,a),this.fire("layeradd",{layer:a})):(L.FeatureGroup.prototype.addLayer.call(this,a),this)},removeLayer:function(a){return this.options.layerTarget?(this.options.layerTarget.removeLayer.call(this.options.layerTarget,a),this.fire("layerremove",{layer:a})):(L.FeatureGroup.prototype.removeLayer.call(this,a),this)},clearLayers:function(){var a=this,b=this._map.getBounds();return a.options.layerTarget?a.options.layerTarget.eachLayer(function(c){a._contains(b,c)||(a.options.layerTarget.removeLayer(c),delete a._markersCache[c._cacheId])}):a.eachLayer(function(c){a._contains(b,c)||(a.removeLayer(c),delete a._markersCache[c._cacheId])},a),this},_debouncer:function(a,b){var c;return b=b||300,function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,Array.prototype.slice.call(e))},b)}},_getPath:function(a,b){var c=b.split("."),d=c.pop(),e=c.length,f=c[0],g=1;if(e>0)for(;(a=a[f])&&e>g;)f=c[g++];return a?a[d]:void 0},_defaultBuildIcon:function(a,b){return new L.Icon.Default},_defaultDataToMarker:function(a,b){var c=this._getPath(a,this.options.propertyTitle),d=L.Util.extend({icon:this._buildIcon(a,c),title:c},a),e=new L.Marker(b,d),f=null;return this.options.buildPopup&&(f=this.options.buildPopup(a,e))&&e.bindPopup(f,this.options.optsPopup),e},addMarker:function(a){var b,c,d=this.options.propertyLoc;if(L.Util.isArray(d))b=L.latLng(parseFloat(this._getPath(a,d[0])),parseFloat(this._getPath(a,d[1])));else if(this.options.locAsGeoJSON){var e=this._getPath(a,d);b=L.latLng(e[1],e[0])}else b=L.latLng(this._getPath(a,d));return c=this.options.cacheId?this.options.cacheId.call(this,a,b):this.options.propertyId?this._getPath(a,this.options.propertyId):b.lat+""+b.lng+this._getPath(a,this.options.propertyTitle),"undefined"==typeof this._markersCache[c]&&(this._markersCache[c]=this._dataToMarker(a,b),this._markersCache[c]._cacheId=c,this.addLayer(this._markersCache[c])),c},_contains:function(a,b){var c;return b.getLatLng?c=b.getLatLng():b.getBounds&&(c=b.getBounds()),a.contains(c)},_loadCacheToBounds:function(a){for(var b in this._markersCache)this._markersCache[b]&&(this._contains(a,this._markersCache[b])?this.addLayer(this._markersCache[b]):this.removeLayer(this._markersCache[b]))},_onMove:function(a){var b=this._map.getZoom(),c=this._map.getCenter(),d=this._map.getBounds();if(b<this.options.minZoom)return!1;if(this.options.minShift&&this._center.distanceTo(c)<this.options.minShift)return!1;if(this._center=c,this.options.caching){if(this._cacheBounds.contains(d))return this._loadCacheToBounds(d),!1;this._cacheBounds.extend(d)}else this.clearLayers();this.update()},update:function(){var a=this,b=a.options.precision,c=a._map.getBounds(),d=c.getSouthWest(),e=c.getNorthEast(),f=[[parseFloat(d.lat.toFixed(b)),parseFloat(d.lng.toFixed(b))],[parseFloat(e.lat.toFixed(b)),parseFloat(e.lng.toFixed(b))]];a._hashUrl&&(f=L.Util.template(a._hashUrl,{lat1:f[0][0],lon1:f[0][1],lat2:f[1][0],lon2:f[1][1]})),a._curReq&&a._curReq.abort&&a._curReq.abort(),a.fire("dataloading",{req:f}),a._curReq=a._callData(f,function(b){a._curReq=null,a._filterData&&(b=a._filterData(b)),a.options.propertyItems&&(b=a._getPath(b,a.options.propertyItems)),a.fire("dataloaded",{data:b}),a.updateMarkers(b)})},updateMarkers:function(a){var b={};for(var c in a)if(!isNaN(parseFloat(c))&&isFinite(c)){var d=this.addMarker.call(this,a[c]);b[d]=1}if(this.options.updateMarkers)for(var e in this._markersCache)b[this._markersCache[e]._cacheId]?this.addLayer(this._markersCache[e]):this.removeLayer(this._markersCache[e])},getAjax:function(url,cb){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(a){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(b){throw new Error("XMLHttpRequest is not supported")}}});var request=new XMLHttpRequest;return request.open("GET",url),request.onreadystatechange=function(){var response={};if(4===request.readyState&&200===request.status){try{response=window.JSON?JSON.parse(request.responseText):eval("("+request.responseText+")")}catch(err){throw response={},new Error("Ajax response is not JSON")}cb(response)}},request.send(),request},getJsonp:function(a,b){var c=document.getElementsByTagName("body")[0],d=L.DomUtil.create("script","leaflet-layerjson-jsonp",c);return L.LayerJSON.callJsonp=function(a){b(a),c.removeChild(d)},d.type="text/javascript",d.src=a+"L.LayerJSON.callJsonp",{abort:function(){d.parentNode.removeChild(d)}}}}),L.layerJSON=function(a){return new L.LayerJSON(a)}}).call(this);